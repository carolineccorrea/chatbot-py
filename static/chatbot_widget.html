<link rel="stylesheet" href="/static/chatbot_widget.css">

<div id="chatbot-container">
  <button id="chatbot-toggle" onclick="toggleChat()">
    <div class="chat-icon-bubble">
      <object
        id="chatbot-icon"
        type="image/svg+xml"
        data="/static/img/balao4.svg"
        aria-label="Abrir chatbot">
        <!-- fallback -->
        <img src="/static/img/balao4.svg" alt="Abrir chatbot" />
      </object>
    </div>
  </button>
  <div id="chatbot-box">
    <div id="chatbot-header">Atendente Virtual</div>
    <div id="chatbot-messages"></div>
    <input
      id="chatbot-input"
      type="text"
      placeholder="Digite sua mensagem..."
      onkeypress="if(event.key === 'Enter') sendMessage()"
    />
  </div>
</div>

<script src="env.js"></script>
<script>
  let sessionId = null;
  const backendUrl = "/chat";
  const apiKey = window.env?.API_KEY || "";

  if (!apiKey) {
    alert("⚠️ API Key não carregada. Verifique o arquivo env.js.");
  }

  async function toggleChat() {
    const box = document.getElementById("chatbot-box");
    box.style.display = box.style.display === "flex" ? "none" : "flex";
    if (!sessionId) await startSession();
  }

  async function startSession() {
    try {
      const res = await fetch("/start-session", {
        method: "POST",
        headers: { "x-api-key": apiKey }
      });
      const data = await res.json();
      sessionId = data.session_id;
    } catch (error) {
      displayMessage("Bot", "Erro ao iniciar sessão. Verifique a chave da API.");
    }
  }

  async function sendMessage() {
    const input = document.getElementById("chatbot-input");
    const msg = input.value.trim();
    if (!msg) return;

    displayMessage("Você", msg);
    input.value = "";

    try {
      const res = await fetch(backendUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey
        },
        body: JSON.stringify({ session_id: sessionId, message: msg })
      });

      if (!res.ok) throw new Error("Erro no servidor");

      const data = await res.json();
      const resposta = data.messages.at(-1).text;
      displayMessage("Bot", resposta);
    } catch (error) {
      displayMessage("Bot", "❌ Erro ao enviar mensagem");
      console.error(error);
    }
  }

  function displayMessage(sender, text) {
    const area = document.getElementById("chatbot-messages");
    const div = document.createElement("div");
    div.innerHTML = `<strong>${sender}:</strong> ${text}`;
    area.appendChild(div);
    area.scrollTop = area.scrollHeight;
  }
</script>
